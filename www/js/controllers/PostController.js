/**
 * Created by Seva on 08/04/2016.
 */

angular.module('garage')
  .controller('PostCtrl', ['$scope', '$cordovaCamera','sharedUser','postService',
    function ($scope, $cordovaCamera, sharedUser, postService) {

    $scope.serverURL = "http://192.168.100.5:3000/posts";

      $scope.comment = {text:"", author:sharedUser.getProperty().name};
    $scope.my_posts = [];

      $scope.emptyImg = true;
      $scope.postPosted = false;
$scope.temp = [];
      $scope.getUserPosts = function () {
        sharedUser.getUserPosts().success(function(data){
          $scope.my_posts = data;
          for (var i = 0; i < $scope.my_posts.length; i++) {
            $scope.my_posts[i].image = "http://192.168.100.5:3000/" + $scope.my_posts[i].image.replace('\\', "/");

          }
          for(i=0; i<$scope.my_posts.length; i++){
            postService.getComments($scope.my_posts[i]._id, sharedUser.getProperty()._id).success(function(data){
              $scope.temp = data;
            });
            $scope.my_posts.comments = $scope.temp;
          }
        });
      };

      $scope.addComment = function (post) {
        postService.addComment(post._id, $scope.comment, sharedUser.getProperty()._id);
        post.comments.push($scope.comment);
      };


      $scope.deletePost = function (value) {
        postService.deletePost(value, sharedUser.getProperty()._id);
      };

    $scope.post = {
      image: "",
      actualWidth: 0,
      actualHeight: 0,
      message: "",
      price: "",
      comments: [],
      location: "",
      is_available: true
    };


    // Upload image to server
    $scope.upload = function () {
      console.log("clicked upload "+ $scope.post.price);
      var imageURI = document.getElementById('post_image').src;

      //var ft = new FileTransfer(),
      var options = {},
        ft = new FileTransfer();

      options.fileKey = "file";
      options.fileName = 'filename.jpg'; // We will use the name auto-generated by Node at the server side.
      options.mimeType = "image/jpeg";
      options.chunkedMode = false;
      options.params = { // Whatever you populate options.params with, will be available in req.body at the server-side.
        "price": $scope.post.price,
        "message": $scope.post.message,
        "userId": sharedUser.getProperty()._id,
        "location": $scope.post.location
      };

      ft.upload(imageURI, $scope.serverURL+"?user="+sharedUser._id,
        function (e) {
          $scope.postPosted=true;

        },
        function (e) {
          alert("Upload failed");
          console.log(e);
        }, options);
    };


    // Take a picture using the camera or select one from the library
    $scope.takePicture = function (e) {
      console.log("going to take a picture");
      $scope.postPosted = false;
      document.addEventListener("deviceready", function () {
        var options = {
          destinationType: Camera.DestinationType.FILE_URI,
          sourceType: Camera.PictureSourceType.CAMERA,
          //targetWidth: 640,
          //targetHeight: 320,
          allowEdit: true,
          correctOrientation: true
        };

        $cordovaCamera.getPicture(options).then(function (imageURI) {
          var image = document.getElementById('post_image');
          image.src = imageURI;
          $scope.emptyImg = false;
          //$scope.clicked = true;
          console.log(imageURI);
        }, function (err) {
          console.log(err);
        });

      }, false);

    };
  }]);
